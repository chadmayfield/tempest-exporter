name: Build

on:
  push:
    branches: [main]
    tags: ["v*"]
  pull_request:
    branches: [main]

permissions:
  contents: read
  packages: write
  id-token: write # Required for cosign keyless signing

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff # v5
        with:
          go-version: "1.24"

      - name: Verify dependencies
        run: go mod verify

      - name: Test
        run: go test ./... -race -count=1

      - name: Vet
        run: go vet ./...

      - name: Vulnerability check
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@latest
          govulncheck ./...

  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff # v5
        with:
          go-version: "1.24"

      - name: golangci-lint
        uses: golangci/golangci-lint-action@9fae48acfc02a90574d7c304a1758ef9895495fa # v7
        with:
          version: v2.9.0

  build:
    needs: [test, lint]
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff # v5
        with:
          go-version: "1.24"

      - uses: ko-build/setup-ko@d982fec422852203cfb2053a8ec6ad302280d04d # v0.8

      - uses: sigstore/cosign-installer@f713795cb21599bc4e5c4b58cbad1da852d7eeb9 # v3

      - name: Login to GHCR
        run: echo "${{ secrets.GITHUB_TOKEN }}" | ko login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Build and push (main branch)
        if: github.ref == 'refs/heads/main'
        id: build-main
        run: |
          IMAGE=$(ko build . --bare --tags=latest,${{ github.sha }} --sbom=spdx)
          echo "image=$IMAGE" >> "$GITHUB_OUTPUT"
        env:
          KO_DOCKER_REPO: ghcr.io/${{ github.repository }}
          VERSION: ${{ github.sha }}

      - name: Build and push (version tag)
        if: startsWith(github.ref, 'refs/tags/v')
        id: build-tag
        run: |
          IMAGE=$(ko build . --bare --tags=${{ github.ref_name }},latest --sbom=spdx)
          echo "image=$IMAGE" >> "$GITHUB_OUTPUT"
        env:
          KO_DOCKER_REPO: ghcr.io/${{ github.repository }}
          VERSION: ${{ github.ref_name }}

      - name: Sign image (main branch)
        if: github.ref == 'refs/heads/main' && steps.build-main.outputs.image != ''
        run: cosign sign --yes ${{ steps.build-main.outputs.image }}

      - name: Sign image (version tag)
        if: startsWith(github.ref, 'refs/tags/v') && steps.build-tag.outputs.image != ''
        run: cosign sign --yes ${{ steps.build-tag.outputs.image }}
